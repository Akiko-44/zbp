<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <link rel="stylesheet" type="text/css" href="../../dist/css/all.css" />
  <link rel="stylesheet" type="text/css" href="../../src/js/vue/index.css" />
  <script src="../../dist/js/lib.js"></script>
  <script src="../../dist/js/v.js"></script>
  <title><%= title %></title>
  <style>
    body {
      background-color: #f2f2f2;
    }

    .et_main {
      width: 1200px;
      margin: 0 auto 30px;
      background-color: #fff;
      padding-bottom: 100px;
    }

    .et_content {
      width: 520px;
      margin: auto;
      padding-top: 45px;
    }

    .et_content h3 {
      font-weight: normal;
      color: #666;
      text-align: center;
      margin: 0 0 30px;
    }

    .et_form_item {
      display: flex;
      position: relative;
    }

    .et_form_item span {
      width: 50px;
      text-align: center;
      height: 52px;
      line-height: 52px;
      color: red;
      font-size: 18px;
    }

    .et_form_item input,
    .et_form_item select {
      height: 52px;
    }

    .et_form_item input,
    .et_form_item .select,
    .et_form_item textarea {
      flex: 1;
      margin-bottom: 20px;
      padding-left: 15px;
      border: 1px solid #dbdbdb;
      border-radius: 3px;
    }

    input::-webkit-input-placeholder {
      color: #b4b4b4;
    }

    input::-moz-placeholder {
      /* Mozilla Firefox 19+ */
      color: #b4b4b4;
    }

    input:-moz-placeholder {
      /* Mozilla Firefox 4 to 18 */
      color: #b4b4b4;
    }

    input:-ms-input-placeholder {
      /* Internet Explorer 10-11 */
      color: #b4b4b4;
    }

    .et_form_item textarea {
      height: 200px;
      padding-top: 16px;
    }

    .et_submit {
      width: 288px;
      height: 50px;
      background-color: rgb(224, 115, 89);
      color: #fff;
      line-height: 50px;
      text-align: center;
      margin-left: 50px;
      cursor: pointer;
    }

    .et_tips {
      margin: 0 0 30px 50px;
      font-size: 14px;
      color: #999;
    }

    .box {
      flex: 1;
      margin-bottom: 20px;
    }

    .imgFileUploade {
      width: 100%;
      display: flex;
    }

    .imgFileUploade .header {
      height: 69px;
      width: 100%;
      line-height: 50px;
      position: absolute;
      top: 0;
    }

    .imgFileUploade .header span {
      display: block;
      float: left;
    }

    .imgFileUploade .header span.imgTitle {
      line-height: 50px;
    }

    .imgFileUploade .header span.imgTitle b {
      color: red;
      margin: 0 5px;
      line-height: 57px;
      display: block;
      float: right;
      font-size: 20px;
    }

    .imgFileUploade .header span.imgClick {
      width: 50px;
      height: 50px;
      margin: 10px 0 0 30px;
      cursor: pointer;
      background: url(/src/img/hx_img/addUpload.png) no-repeat center center;
      background-size: cover;
    }

    .imgFileUploade .header span.imgcontent {
      color: #999;
      margin-left: 120px;
      line-height: 50px;
    }

    .imgFileUploade .imgAll {
      width: 100%;
    }

    .imgFileUploade .addimg {
      width: 100px;
      height: 30px;
      line-height: 30px;
      background-color: rgb(235, 236, 241);
      color: #999;
      margin-left: 7px;
      position: absolute;
      bottom: 12px;
    }

    .imgFileUploade .imgAll ul {
      padding: 0;
      margin: 0;
    }

    .imgFileUploade .imgAll ul:after {
      visibility: hidden;
      display: block;
      font-size: 0;
      content: ".";
      clear: both;
      height: 0
    }

    .imgFileUploade .imgAll li {
      width: 109px;
      height: 109px;
      border: solid 1px #ccc;
      margin: 0px 4px;
      float: left;
      position: relative;
      box-shadow: 0 0 10px #eee;
      list-style: none;
      margin-top: 4px;
    }

    .imgFileUploade .imgAll li img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: block;
    }

    .delImg {
      position: absolute;
      top: -10px;
      right: -7px;
      width: 22px;
      height: 22px;
      background: #000;
      border-radius: 50%;
      display: block;
      text-align: center;
      line-height: 22px;
      color: #fff;
      font-weight: 700;
      font-style: normal;
      cursor: pointer;
    }

    /* .box{
		border:solid 1px #ccc;
	} */
    .chooseimg {
      border: 1px solid #dbdbdb;
      width: 150px;
      text-align: center;
      height: 109px;
      background: #fff;
      position: relative;
      margin-top: 4px;
    }

    #uploadimg {
      width: 114px;
      height: 108px;
      position: absolute;
      left: 0;
      z-index: 99;
      opacity: 0;
    }

    #form1 {
      height: 100px;
    }

    option::-ms-expand {
      display: none;
    }

    option {
      -moz-appearance: none;
      /* Firefox */
      -webkit-appearance: none;
      /* Safari 和 Chrome */
      appearance: none;
    }

    /* --背景色字体颜色--*/
    option:hover {
      color: #fff;
      background-color: #dedede;
    }

    .close {
      width: 20px !important;
      height: 20px !important;
      right: -10px !important;
      position: absolute !important;
      left: auto !important;
      top: -10px !important;
    }

    .close {
      width: 20px !important;
      height: 20px !important;
      right: -10px !important;
      position: absolute !important;
      left: auto !important;
      top: -10px !important;
    }

    .tip,
    .tipshop,
    .tipbrand {
      position: absolute;
      left: 66px;
      margin-top: 20px;
      color: #b3b0b0;
    }

    .handdleoption {
      position: absolute;
      left: 50px;
      top: 40px;
      height: 30px;
      line-height: 30px;
      background: #eee;
      width: 470px;
      z-index: 999;
      color: #999;
    }

    .handdleoption li {
      padding-left: 20px;
    }

    .et_form_item .select {
      height: 40px;
      line-height: 40px;
      color: #a7a2a2;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .mechantnameItem {
      cursor: pointer;
      background: #eee;
    }

    .downIcon {
      width: 10px;
      height: 10px;
      margin-right: 18px;
    }
  </style>
</head>
<script src="/src/js/valite.js"></script>

<body>
  <%- include ../headerbar.ejs %>
  <%- include ../headerNav.ejs %>
  <div class="container">
    <div class="router" id="router">
      <el-breadcrumb separator-class="el-icon-arrow-right">
        <el-breadcrumb-item>
          <a href="/">首页</a>
        </el-breadcrumb-item>
        <el-breadcrumb-item :to="{ path: '/' }">
          <a href="/user/Complaint">投诉</a>
        </el-breadcrumb-item>
        <el-breadcrumb-item>投诉入口</el-breadcrumb-item>
      </el-breadcrumb>
    </div>
  </div>
  <div class='form et_main' id="app">
    <div class='et_content'>
      <h3>请如实描述您所遇到的问题</h3>
      <div class='et_form'>
        <div class='et_form_item'>
          <span>*</span>
          <input type="text" ref="name" placeholder="请输入姓名" v-model="name">
        </div>
        <div class='et_form_item'>
          <span>*</span>
          <input type="text" disabled :value="phone | formatphone">
        </div>
        <div class='et_form_item'>
          <span></span>
          <input type="text" placeholder="请输入邮箱（选填）" v-model="email" @input="getval('email')" ref="email">
        </div>
        <div class='et_form_item'>
          <span>*</span>
          <!-- <p class="tip" ref="shopname"></p> -->
          <div class="select select1" @click="selectinfo(item,this)">
            <p>请选择投诉商家名称</p>
            <img class="downIcon" src="/src/img/hx_img/down.png" alt="">
          </div>
          <ul class="handdleoption" v-show="mechantname">
            <li v-for="(item,index) in allinfo" class="mechantnameItem" @click="handlemechantName(item)"
              @mouseenter="handleEnter($event)" @mouseleave="handleLeave($event)" :value="item">
              {{item.mechantName}}</li>
          </ul>
        </div>
        <div class='et_form_item'>
          <span>*</span>
          <!-- <p class="tipshop" ref="tipshop">请选择投诉商品</p>
                    <select v-on:change="selectinfonew(itemshop)" v-model="itemshop">
                        <option v-for="(itemshop,index) in newinfo" :value="itemshop">{{itemshop.goodName}}</option>
                    </select> -->
          <div class="select select2" @click="selectgoodName()">
            <p>请选择投诉商品</p>
            <img class="downIcon" src="/src/img/hx_img/down.png" alt="">
          </div>
          <ul class="handdleoption" v-show="itemselectshop">
            <li v-for="(item,index) in newinfo" class="mechantnameItem" @click="handleselectshop(item)"
              @mouseenter="handleEnter($event)" @mouseleave="handleLeave($event)" :value="item">
              {{item.goodName}}</li>
          </ul>
        </div>
        <div class='et_form_item'>
          <span></span>
          <!-- <p class="tipbrand" ref="tipbrand">请选择投诉品牌</p>
                    <select v-on:change="selectname(itemname)" v-model="itemname">
                        <option :value="newinfoitem">{{newinfoitem}}</option>
                    </select> -->
          <div class="select select3" @click="selectBrandName()">
            <p>请选择投诉品牌</p>
            <img class="downIcon" src="/src/img/hx_img/down.png" alt="">
          </div>
          <ul class="handdleoption" v-show="itemselectBrand">
            <li v-for="(item,index) in newinfo" v-if="item.brandName" class="mechantnameItem"
              @click="handleselectBrandName(item)" @mouseenter="handleEnter($event)" @mouseleave="handleLeave($event)"
              :value="item">
              {{item.brandName}}</li>
            <!-- <li v-else>暂无品牌</li> -->
          </ul>
        </div>
        <div class='et_form_item'>
          <span>*</span>
          <input type="text" placeholder="请输入投诉标题，30字以内" v-model="title" @input="getval('order')" maxlength="30"
            ref="order">
        </div>
        <div class='et_form_item'>
          <span>*</span>
          <textarea type="text" placeholder="请输入投诉内容，500字以内" maxlength="500" data-dv-name="true"
            data-dv-name-error="请输入内容" v-model="content" ref="content" @input="getval('content')"></textarea>
        </div>
        <div class='et_form_item'>
          <span>*</span>
          <div class="box">
            <div class="imgFileUploade">
              <div class="chooseimg">
                <input type="file" id="uploadimg" name="cloudfile" ref="inputfile" accept="image/*"
                  @change="uploadGoodsImg(this)">
                <div class="header"><span class="imgClick" @click="uploadimg"></span></div>
                <div class="addimg"><a>+添加图片</a></div>
              </div>
              <div class="imgAll">
                <ul>
                  <li v-for="(item,index) in Img">
                    <img :src="item" alt="">
                    <img class="close" @click="close(index)" src="/src/img/hx_img/closeImg.png" alt="">
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <p class='et_tips'>九张以内，支持jpg/png/gif/jpeg,单张 图片大小3M以内</p>
        <div class='et_submit' @click="submit($event)">提交</div>
      </div>
    </div>
  </div>
  <%- include ../footer.ejs %>
  <script>
    var routerVm = new Vue({
      el: "#router"
    })
    var app = new Vue({

      el: "#app",
      data: {
        phone: '',
        item: '',
        allinfo: [],
        newinfo: [],
        itembrand: "请选择投诉商品",
        newinfoitem: '',
        itemname: '1232323',
        itemshop: '',
        title: '',
        order: '',
        name: '',
        content: '',
        email: '',
        selectBrand: '',
        itemselectBrand: false,
        itemselectshop: false,
        Img: [],
        mechantname: false
      },
      filters: {
        formatphone(val) {
          return val.substr(0, 3) + "****" + val.substr(7)
        }
      },
      mounted() {
        this.phone = utils.getCookie("phone");
        this._Getcomplain()
      },
      methods: {
        uploadGoodsImg(e) {
          let inputfile = this.$refs.inputfile
          var formFile = this.formatUpLoadImg(inputfile.files[0], 3)
          if (formFile && this.Img && this.Img.length < 9) {
            this.Img.push(this._TemplateUploadImgAjax("post", "/api/pic/upload", formFile))
          }
        },
        // 格式化图片
        formatUpLoadImg(_file, _fileSize) {
          var formFile = new FormData();
          var file = _file;
          var fileSize = (file.size / 1024 / 1024).toFixed(0);
          console.log("size", fileSize);
          if (fileSize > _fileSize) {
            alert("上传的文件不能超过" + fileSize + "M")
            return
          }
          formFile.append("file", file); //加入文件对象
          return formFile
        },
        // data类型FormData
        _TemplateUploadImgAjax(type, url, data) {
          var that = this;
          var params;
          $.ajax({
            url: url,
            data: data,
            type: type,
            async: false,
            cache: false,
            contentType: false, //不设置内容类型
            processData: false, //不处理数据
            success: function (res) {
              params = res.data.picUrl
            }
          })
          return params
        },
        _Getcomplain() {
          var that = this;
          utils.ajax({
            url: '/api/portal/fightingFalse/getComplaintMechantGoodsBrand',
            type: "get",
            sysnc: false,
            data: {
              phoneNumber: that.phone
            },
            success: function (res) {
              that.allinfo = res.data
            }
          })
        },
        selectinfo(item) {
          this.itembrand = item
          this.mechantname = !this.mechantname;
          this.mechantName = item.mechantName;
          // this.$refs.mechantSelectName.style.innerHTML= item.mechantName
          console.log('item.complaintGoodsVOS', item.complaintGoodsVOS);

          this.newinfo = item.complaintGoodsVOS ? item.complaintGoodsVOS : [];
        },
        selectgoodName() {
          this.itemselectshop = !this.itemselectshop;
        },
        handleEnter(e) {
          $(e.target).css("background", "#dedede")
        },
        handleLeave(e) {
          $(e.target).css("background", "#efefef")
        },
        handlemechantName(item) {
          console.log($(".select").html());
          $(".select1").html(item.mechantName)

          this.selectinfo(item)

        },
        handleselectshop(item) {
          this.goodName = item.goodName
          this.goodId = item.goodId;
          $(".select2").html(item.goodName);
          this.itemselectshop = false
        },
        selectBrandName() {
          this.itemselectBrand = !this.itemselectBrand
          console.log('newinfo', this.newinfo);

        },
        handleselectBrandName() {

        },
        // selectinfonew(item) {
        //     this.newinfoitem = item.brandName;
        //     this.goodName = item.goodName;
        //     this.goodId = item.goodId;
        //     this.$refs.tipshop.style.display = "none"
        // },
        // selectname(item) {
        //     this.selectBrand = item;
        //     this.$refs.tipbrand.style.display = "none"
        // },
        _getRef(params) {
          return this.$refs[params].value
        },
        getval(val) {
          this[val] = this._getRef(val);
        },
        close(index) {
          this.Img.splice(index, 1)
        },
        submit(e) {
          var that = this
          // if (!this.name || !this.phone || !this.email || !this.content || !this.order || !this.mechantName || !this.goodName || !this.Img.length) return
          if (!this.name) {
            utils.alert('danger', '请输入姓名');
            return false
          }

          if (!this.mechantName) {
            utils.alert('danger', '请选择投诉商家名称');
            return false
          }
          if (!this.order) {
            utils.alert('danger', '请输入投诉标题');
            return false
          }
          if (!this.goodName) {
            utils.alert('danger', '请选择投诉商品');
            return false
          }
          if (!this.content) {
            utils.alert('danger', '请输入内容');
            return false
          }
          if (!this.Img.length) {
            utils.alert('danger', '请选择图片');
            return false
          }
          var data = {
            userName: this.name,
            mobilePhone: this.phone,
            // brandName: this.newinfoitem,
            merchantName: this.mechantName,
            merchantPhone: this.phone,
            goodName: this.goodName,
            goodId: this.goodId,
            complaintName: this.order,
            complaintContent: this.content,
            imgUrl: this.Img
          }
          utils.ajax({
            url: '/api/portal/fightingFalse/save',
            type: "post",
            data: JSON.stringify(data),
            el: e.target,
            success: function (res) {
              utils.alert('success', "提交成功!");
              // that.order = "";
              // that.name = that.newinfoitem = that.email = that.mechantName = that.goodName = that.goodId = that.title = that.content = '';
              // that.Img = []
              window.location.href = "/user/Complaint"
            }
          })
        }
      }
    })
    $(".form").valite({
      initEvent: 'blur',
      sign: 'dv',
    })
  </script>
</body>

</html>